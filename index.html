<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>1-phase PV router: A 1-phase photovoltaic router/diverter</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">1-phase PV router
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">A 1-phase photovoltaic router/diverter </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="description"></a>
Description</h1>
<p><a class="el" href="Mk2__fasterControl__Full_8ino.html" title="A photovoltaic energy diverter.">Mk2_fasterControl_Full.ino</a> - Arduino program that maximizes the use of home photovoltaic production by monitoring energy consumption and diverting power to one or more resistive charge(s) when needed. In the absence of such a system, surplus energy flows away to the grid and is of no benefit to the PV-owner.</p>
<h1><a class="anchor" id="history"></a>
History</h1>
<p><b>May 2025, updated Mk2_fasterControl_Full with these changes:</b></p><ul>
<li>heavy refactoring to make the code more readable and maintainable.</li>
<li>added even more comments to explain the code.</li>
<li>added telemetry for use with Home Assistant (with additional ESPHome module) or similar.</li>
<li>disable diverted energy counting when load is overridden.</li>
<li>better Doxygen documentation.</li>
<li>added support for new PCB-based hardware. Old hardware is still supported.</li>
<li>added support for new OLED display. Old display is still supported.</li>
</ul>
<p><b>November 2024, renamed as Mk2_fasterControl_Full with these changes:</b></p><ul>
<li>heavy refactoring to make the code more readable and maintainable.</li>
<li>added comments to explain the code.</li>
<li>added assertions to ensure the code is compiled with the correct C++ version.</li>
<li>added a link to the README.md file in the comments.</li>
<li>refactoring of the ISR to enhance the performance.</li>
</ul>
<p><b>Previous history by Robin Emley (www.Mk2PVrouter.co.uk):</b></p>
<p><b>July 2023: updated to Mk2_fasterControl_twoLoads_5 with these changes:</b></p><ul>
<li>the ability to control two loads has been transferred from the latest version of my standard multiLoad sketch, Mk2_multiLoad_wired_7a. The faster control algorithm has been retained. The previous 2-load "faster control" sketch (version 4) has been archived as its behaviour was found to be problematic.</li>
</ul>
<p><b>June 2021: updated to Mk2_fasterControl_3 with these changes:</b></p><ul>
<li>to reflect the performance of recently manufactured YHDC SCT_013_000 CTs, the value of the parameter lpf_gain has been reduced from 12 to 8.</li>
</ul>
<p><b>March 2021: updated to Mk2_fasterControl_2 with these changes:</b></p><ul>
<li>extra filtering added to offset the HPF effect of CT1. This allows the energy state in 10 ms time to be predicted with more confidence. Specifically, it is no longer necessary to include a 30% boost factor after each change of load state.</li>
</ul>
<p><b>February 2020: updated to Mk2_fasterControl_1a with these changes:</b></p><ul>
<li>removal of some redundant code in the logic for determining the next load state.</li>
</ul>
<p><b>November 2019: updated to Mk2_fasterControl_1 with these changes:</b></p><ul>
<li>Half way through each mains cycle, a prediction is made of the likely energy level at the end of the cycle. That predicted value allows the triac to be switched at the +ve going zero-crossing point rather than waiting for a further 10 ms. These changes allow for faster switching of the load.</li>
<li>The range of the energy bucket has been reduced to one tenth of its former value. This allows the unit's operation to commence more rapidly whenever surplus power is available.</li>
<li>controlMode is no longer selectable, the unit's operation being effectively hard-coded as "Normal" rather than Anti-flicker.</li>
<li>Port D3 now supports an indicator which shows when the level in the energy bucket reaches either end of its range. While the unit is actively diverting surplus power, it is vital that the level in the reduced capacity energy bucket remains within its permitted range, hence the addition of this indicator.</li>
</ul>
<p><b>February 2016: updated to Mk2_bothDisplays_4, with these changes:</b></p><ul>
<li>improvements to the start-up logic. The start of normal operation is now synchronized with the start of a new mains cycle.</li>
<li>reduce the amount of feedback in the Low Pass Filter for removing the DC content from the Vsample stream. This resolves an anomaly which has been present since the start of this project. Although the amount of feedback has previously been excessive, this anomaly has had minimal effect on the system's overall behaviour.</li>
<li>removal of the unhelpful "triggerNeedsToBeArmed" mechanism</li>
<li>tidying of the "confirmPolarity" logic to make its behaviour more clear</li>
<li>SWEETZONE_IN_JOULES changed to WORKING_ZONE_IN_JOULES</li>
<li>change "triac" to "load" wherever appropriate</li>
</ul>
<p><b>January 2016: updated to Mk2_bothDisplays_3c:</b> The variables to store the ADC results are now declared as "volatile" to remove any possibility of incorrect operation due to optimisation by the compiler.</p>
<p><b>January 2016: renamed as Mk2_bothDisplays_3b, with this change:</b></p><ul>
<li>a minor change in the ISR to remove a timing uncertainty.</li>
</ul>
<p><b>December 2014: renamed as Mk2_bothDisplays_3a, with some typographical errors fixed.</b></p>
<p><b>December 2014: renamed as Mk2_bothDisplays_3, with these changes:</b></p><ul>
<li>persistence check added for zero-crossing detection (polarityConfirmed)</li>
<li>lowestNoOfSampleSetsPerMainsCycle added, to check for any disturbances</li>
</ul>
<p><b>September 2014: renamed as Mk2_bothDisplays_2, with these changes:</b></p><ul>
<li>cycleCount removed (was not actually used in this sketch, but could have overflowed);</li>
<li>removal of unhelpful comments in the IO pin section;</li>
<li>tidier initialisation of display logic in <a class="el" href="main_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d" title="Called once during startup.">setup()</a>;</li>
<li>addition of REQUIRED_EXPORT_IN_WATTS logic (useful as a built-in PV simulation facility);</li>
</ul>
<p><b>Issue 1 was released as Mk2_bothDisplays_1 in March 2014.</b></p>
<p>This sketch is for diverting surplus PV power to a dump load using a triac or Solid State Relay. It is based on the Mk2i PV Router code that I have posted in on the OpenEnergyMonitor forum. The original version, and other related material, can be found on my Summary Page at www.openenergymonitor.org/emon/node/1757</p>
<p>In this latest version, the pin-allocations have been changed to suit my PCB-based hardware for the Mk2 PV Router. The integral voltage sensor is fed from one of the secondary coils of the transformer. Current is measured via Current Transformers at the CT1 and CT1 ports.</p>
<p>CT1 is for 'grid' current, to be measured at the grid supply point. CT2 is for the load current, so that diverted energy can be recorded</p>
<p>A persistence-based 4-digit display is supported. This can be driven in two different ways, one with an extra pair of logic chips, and one without. The appropriate version of the sketch must be selected by including or commenting out the "#define PIN_SAVING_HARDWARE" statement near the top of the code.</p>
<dl class="section author"><dt>Author</dt><dd>Fred Metrich </dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright (c) 2025 </dd></dl>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2
</small></address>
</div><!-- doc-content -->
</body>
</html>
